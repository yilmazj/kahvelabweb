<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KahveLab - Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8B0000;
            --primary-light: #A61C26; 
            --gold: #D4AF37;
            --bg-body: #F9F9F9;
            --bg-card: #FFFFFF;
            --bg-nav: rgba(255, 255, 255, 0.9);
            --text-main: #2C0309;
            --text-sub: #8E8E93;
            --text-highlight: #FFFFFF;
            --border-color: #E5E5EA;
            --nav-height: 85px;
        }

        body.dark-mode {
            --bg-body: #1a0204;
            --bg-card: #2a0508;
            --bg-nav: rgba(20, 0, 0, 0.85);
            --text-main: #FFFFFF;
            --text-sub: rgba(255,255,255,0.6);
            --border-color: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            display: flex; justify-content: center; height: 100vh; overflow: hidden; user-select: none;
            transition: background-color 0.3s ease;
        }

        #app {
            width: 100%; max-width: 414px; height: 100%;
            background-color: var(--bg-body); color: var(--text-main);
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        .screen {
            display: none; flex-direction: column; height: 100%; width: 100%;
            overflow-y: auto; padding-bottom: var(--nav-height);
            background: var(--bg-body); animation: fadeIn 0.4s ease;
        }

        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }

        /* --- HEADER --- */
        .header { padding: 15px 24px; padding-top: 50px; display: flex; justify-content: space-between; align-items: center; z-index: 20; }
        .header-brand { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 900; color: var(--text-main); letter-spacing: 1px; width: 100%; text-align: center; }
        body.dark-mode #home-screen .header-brand { color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        body:not(.dark-mode) #home-screen .header-brand { color: var(--primary); }
        .header-title { font-size: 18px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); color: var(--text-main); }

        /* --- HERO --- */
        .hero-section {
            padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(180deg, var(--primary-light) 0%, var(--primary) 100%);
            position: relative; min-height: 360px; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 10px 40px rgba(139, 0, 0, 0.3); margin-bottom: 20px;
        }
        .pulse-container { position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 320px; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .circle-bg { position: absolute; width: 300px; height: 300px; border-radius: 50%; border: 1px solid rgba(255, 215, 0, 0.4); animation: pulse 3s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.15); opacity: 0.8; } }

        .main-fal-btn {
            width: 160px; height: 160px; border-radius: 50%; background: linear-gradient(135deg, #8B0000 0%, #500000 100%);
            border: 3px solid var(--gold); color: white; z-index: 5; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; transition: transform 0.2s;
        }
        .main-fal-btn:active { transform: scale(0.95); }
        .main-fal-btn i { font-size: 44px; }

        /* --- UI COMPONENTS --- */
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: var(--nav-height); background: var(--bg-nav); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 20px; border-top: 1px solid var(--border-color); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 11px; gap: 6px; cursor: pointer; width: 70px; font-weight: 500; }
        .nav-item.active { color: var(--primary) !important; }
        body.dark-mode .nav-item.active { color: white !important; }

        .widget-card { background: var(--bg-card); border-radius: 18px; padding: 16px; border: 1px solid var(--border-color); color: var(--text-main); }
        .auth-input, .onboard-input { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 15px; }
        .submit-btn { width: 100%; padding: 16px; border-radius: 14px; background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 190; display: none; }
        .modal-overlay.open { display: block; }
        .action-sheet, .modal-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; z-index: 250; background: var(--bg-card); border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 24px; transition: bottom 0.3s ease; border-top: 1px solid var(--border-color); }
        .action-sheet.open, .modal-sheet.open { bottom: 0; }

        /* --- LOADING --- */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body class="dark-mode">

    <div id="loading-overlay">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 40px; color: var(--gold);"></i>
        <p style="margin-top: 15px; font-weight: 600;">Gelecek Hazırlanıyor...</p>
    </div>

    <div id="app">
        <div id="overlay" class="modal-overlay" onclick="closeAllSheets()"></div>

        <div id="auth-screen" class="screen">
            <div class="header">
                <div onclick="navTo('home-screen')" style="font-size:24px; color:var(--text-main);"><i class="fa-solid fa-arrow-left"></i></div>
            </div>
            <div style="padding: 24px;">
                <h2 id="auth-title" style="font-size:32px; font-weight:800; margin-bottom:20px;">Giriş Yap</h2>
                <div id="form-login">
                    <input type="email" id="login-email" class="auth-input" placeholder="E-Posta">
                    <input type="password" id="login-pass" class="auth-input" placeholder="Şifre">
                    <button class="submit-btn" onclick="window.handleLogin()">Giriş Yap</button>
                    <p onclick="switchAuthTab('register')" style="text-align:center; margin-top:15px; color:var(--text-sub); font-size:14px;">Hesabın yok mu? <span style="color:var(--primary); font-weight:700;">Kayıt Ol</span></p>
                </div>
                <div id="form-register" class="hidden">
                    <input type="text" id="reg-name" class="auth-input" placeholder="Ad Soyad">
                    <input type="email" id="reg-email" class="auth-input" placeholder="E-Posta">
                    <input type="password" id="reg-pass" class="auth-input" placeholder="Şifre Oluştur">
                    <button class="submit-btn" onclick="window.handleRegister()">Kayıt Ol</button>
                    <p onclick="switchAuthTab('login')" style="text-align:center; margin-top:15px; color:var(--text-sub); font-size:14px;">Zaten üye misin? <span style="color:var(--primary); font-weight:700;">Giriş Yap</span></p>
                </div>
            </div>
        </div>

        <div id="onboarding-screen" class="screen">
            <div style="padding: 40px 24px;">
                <h2 style="font-family:'Playfair Display'; font-size:28px; margin-bottom:10px;">Seni Tanıyalım</h2>
                <p style="color:var(--text-sub); margin-bottom:30px;">Fallarının sana özel olması için bu bilgilere ihtiyacımız var.</p>
                
                <label style="font-size:12px; font-weight:700; color:var(--gold);">DOĞUM TARİHİ</label>
                <input type="date" id="on-birth" class="onboard-input">
                
                <label style="font-size:12px; font-weight:700; color:var(--gold);">CİNSİYET</label>
                <select id="on-gender" class="onboard-input">
                    <option value="Kadın">Kadın</option>
                    <option value="Erkek">Erkek</option>
                    <option value="Belirtmek İstemiyorum">Belirtmek İstemiyorum</option>
                </select>

                <label style="font-size:12px; font-weight:700; color:var(--gold);">BURÇ</label>
                <select id="on-zodiac" class="onboard-input">
                    <option>Koç</option><option>Boğa</option><option>İkizler</option><option>Yengeç</option>
                    <option>Aslan</option><option>Başak</option><option>Terazi</option><option>Akrep</option>
                    <option>Yay</option><option>Oğlak</option><option>Kova</option><option>Balık</option>
                </select>

                <label style="font-size:12px; font-weight:700; color:var(--gold);">MESLEK</label>
                <input type="text" id="on-job" class="onboard-input" placeholder="Örn: Mühendis, Öğrenci">

                <label style="font-size:12px; font-weight:700; color:var(--gold);">İLİŞKİ DURUMU</label>
                <select id="on-relation" class="onboard-input">
                    <option>Yalnız</option><option>İlişkisi var</option><option>Evli</option><option>Platonik</option><option>Karmaşık</option>
                </select>

                <button class="submit-btn" onclick="window.saveOnboarding()">Devam Et</button>
            </div>
        </div>

        <div id="home-screen" class="screen active">
            <div class="header" style="justify-content: center;"><div class="header-brand">KahveLab</div></div>
            <div class="hero-section">
                <div class="pulse-container"><div class="circle-bg"></div></div>
                <button class="main-fal-btn" onclick="openPhotoOptions()">
                    <i class="fa-solid fa-camera"></i><span>FAL GÖNDER</span>
                </button>
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="window.processImage(this)">
            </div>
            <div style="padding: 0 24px;">
                <div class="section-title">Günün Özeti</div>
                <div id="summary-content" class="widget-card" style="min-height: 100px;">
                    <p style="font-size: 14px; line-height: 1.6;">Kahveni içtiysen fincan fotoğraflarını gönder, geleceğin kapılarını beraber aralayalım...</p>
                </div>
            </div>
        </div>

        <div id="check-info-modal" class="modal-sheet">
            <h3 style="margin-bottom:15px;">Bilgilerini Kontrol Et</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:20px;">Bu bilgiler sadece bu fal için kullanılacak, profilin değişmeyecek.</p>
            <input type="text" id="check-job" class="onboard-input" placeholder="Meslek">
            <select id="check-relation" class="onboard-input">
                <option>Yalnız</option><option>İlişkisi var</option><option>Evli</option><option>Platonik</option>
            </select>
            <button class="submit-btn" onclick="window.confirmAndSend()">Falımı Yorumla</button>
            <button class="action-btn" style="border:none; color:var(--text-sub);" onclick="closeAllSheets()">Vazgeç</button>
        </div>

        <div id="profile-screen" class="screen">
            <div class="header"><div class="header-title">Hesabım</div></div>
            <div class="profile-header" style="text-align:center; padding:20px;">
                <div style="width:70px; height:70px; background:var(--gold); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; color:white; font-size:24px;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <h3 id="display-name">Kullanıcı</h3>
            </div>
            <div class="menu-list" style="padding: 20px;">
                <div class="menu-item" style="display:flex; justify-content:space-between; padding:15px; background:var(--bg-card); border-radius:12px; margin-bottom:10px; border:1px solid var(--border-color);" onclick="openModal('onboarding-screen')">
                    <span><i class="fa-solid fa-id-card" style="margin-right:10px; color:var(--gold);"></i> Hesap Bilgilerim</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
                <div class="menu-item" style="display:flex; justify-content:space-between; padding:15px; background:var(--bg-card); border-radius:12px; border:1px solid var(--border-color);" onclick="window.logoutUser()">
                    <span style="color:#FF3B30;"><i class="fa-solid fa-right-from-bracket" style="margin-right:10px;"></i> Çıkış Yap</span>
                </div>
            </div>
        </div>

        <div id="photo-options-sheet" class="action-sheet">
            <button class="action-btn" onclick="document.getElementById('file-input').click(); closeAllSheets();"><i class="fa-solid fa-image"></i> Galeriden Seç / Foto Çek</button>
            <button class="action-btn" style="color:#FF3B30;" onclick="closeAllSheets()">Vazgeç</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="navTo('home-screen', this)"><i class="fa-solid fa-house"></i><span>Ana Sayfa</span></div>
            <div class="nav-item" onclick="navTo('profile-screen', this)"><i class="fa-solid fa-user"></i><span>Hesabım</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVV5cLOkjaJ3k-FUwqRE4LucN293RPBbM",
            authDomain: "kahvelabweb.firebaseapp.com",
            projectId: "kahvelabweb",
            storageBucket: "kahvelabweb.firebasestorage.app",
            messagingSenderId: "754884541831",
            appId: "1:754884541831:web:4a4cf4046a31b269ea2722"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const GEMINI_KEY = "AIzaSyCjSBmLJsOOb-uG9SRPt2c8cA5cAu1sfdE";

        let currentBase64 = null;
        let userProfile = null;

        // --- AUTH & ONBOARDING ---
        window.handleLogin = async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { alert(err.message); }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            const n = document.getElementById('reg-name').value;
            try { 
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", cred.user.uid), { name: n, email: e, onboardingDone: false });
            } catch(err) { alert(err.message); }
        };

        window.saveOnboarding = async () => {
            const data = {
                birthDate: document.getElementById('on-birth').value,
                gender: document.getElementById('on-gender').value,
                zodiac: document.getElementById('on-zodiac').value,
                job: document.getElementById('on-job').value,
                relation: document.getElementById('on-relation').value,
                onboardingDone: true
            };
            await updateDoc(doc(db, "users", auth.currentUser.uid), data);
            userProfile = { ...userProfile, ...data };
            navTo('home-screen');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    userProfile = snap.data();
                    document.getElementById('display-name').innerText = userProfile.name || "Kullanıcı";
                    if (!userProfile.onboardingDone) navTo('onboarding-screen');
                    else navTo('home-screen');
                }
            } else {
                navTo('auth-screen');
            }
        });

        // --- GEMINI & IMAGE ---
        window.processImage = (input) => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                currentBase64 = reader.result.split(',')[1];
                document.getElementById('check-job').value = userProfile.job || "";
                document.getElementById('check-relation').value = userProfile.relation || "Yalnız";
                openModal('check-info-modal');
            };
            reader.readAsDataURL(file);
        };

        window.confirmAndSend = async () => {
            closeAllSheets();
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const tempInfo = {
                job: document.getElementById('check-job').value,
                relation: document.getElementById('check-relation').value,
                zodiac: userProfile.zodiac,
                gender: userProfile.gender
            };

            const prompt = `Sen mistik ve bilge bir kahve falcısısın. Kullanıcı bilgileri: Cinsiyet:${tempInfo.gender}, Burç:${tempInfo.zodiac}, Meslek:${tempInfo.job}, İlişki Durumu:${tempInfo.relation}. Lütfen bu kahve telvesi fotoğrafını detaylıca yorumla. Gelecekten haberler ver, aşk, para ve sağlık konularına değin. Samimi ve gizemli bir dil kullan.`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: currentBase64 } }] }]
                    })
                });
                const result = await resp.json();
                const text = result.candidates[0].content.parts[0].text;
                document.getElementById('summary-content').innerHTML = `<p style="font-size:14px; line-height:1.6;">${text.replace(/\n/g, '<br>')}</p>`;
            } catch (err) {
                alert("Fal yorumlanırken bir sorun oluştu.");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        };

        // --- UI HELPERS ---
        window.navTo = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
        };
        window.openModal = (id) => {
            document.getElementById('overlay').classList.add('open');
            document.getElementById(id).classList.add('open');
            if(id === 'onboarding-screen') document.getElementById(id).style.display = 'flex';
        };
        window.openPhotoOptions = () => openModal('photo-options-sheet');
        window.closeAllSheets = () => {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.action-sheet, .modal-sheet, .screen').forEach(s => {
                s.classList.remove('open');
                if(s.id === 'onboarding-screen' && userProfile?.onboardingDone) s.style.display = 'none';
            });
            if(userProfile?.onboardingDone) navTo('home-screen');
        };
        window.switchAuthTab = (t) => {
            document.getElementById('form-login').classList.toggle('hidden', t === 'register');
            document.getElementById('form-register').classList.toggle('hidden', t === 'login');
            document.getElementById('auth-title').innerText = t === 'login' ? "Giriş Yap" : "Kayıt Ol";
        };
        window.logoutUser = () => signOut(auth);

    </script>
</body>
</html>